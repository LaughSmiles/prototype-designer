<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title id="pageTitle">画布编辑器</title>

    <!-- 动态加载项目配置并设置标题 -->
    <script>
        (function() {
            fetch('project-config.json')
                .then(response => {
                    if (!response.ok) throw new Error('无法加载项目配置');
                    return response.json();
                })
                .then(config => {
                    document.title = `${config.projectName} - 画布编辑器`;
                })
                .catch(error => {
                    console.warn('使用默认标题:', error);
                    document.title = '画布编辑器';
                });
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/canvas-editor.css">

    <!-- 页面加载时立即设置浏览器缩放防护 -->
    <script>
        // 在DOM加载前就阻止可能的缩放行为
        (function() {
            // 阻止浏览器缩放，但允许canvas-view.js处理画布缩放
            document.addEventListener('wheel', function(e) {
                if (e.ctrlKey) {
                    // 检查是否在iframe内部
                    const isInsideIframe = e.target.closest('.canvas-element.page-element iframe');
                    const isInsideCanvasWrapper = e.target.closest('#canvasWrapper');

                    if (isInsideIframe) {
                        // 在iframe内部：完全阻止浏览器缩放
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        return false;
                    } else if (isInsideCanvasWrapper && !isInsideIframe) {
                        // 在画布区域：只阻止浏览器默认缩放，但不阻止事件传播
                        // 这样canvas-view.js的监听器就能接收到事件并执行画布缩放
                        e.preventDefault();
                        // 注意：这里不调用 stopImmediatePropagation()
                        // 让事件继续传播给canvas-view.js处理
                    }
                    // 其他区域：不阻止，让浏览器默认行为
                }
            }, { passive: false, capture: true });

            // 阻止所有键盘缩放快捷键
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && (e.key === '+' || e.key === '=' || e.key === '-' || e.key === '0')) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, { capture: true });

            // 阻止触摸手势缩放
            document.addEventListener('touchmove', function(e) {
                if (e.scale && e.scale !== 1) {
                    e.preventDefault();
                    return false;
                }
            }, { passive: false, capture: true });

            // 阻止双指缩放手势
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
                return false;
            }, { capture: true });
        })();
    </script>
</head>
<body>
    <!-- 主容器 - 三栏布局 -->
    <div class="app-container">
        <!-- 左侧工具栏 -->
        <aside class="sidebar-left">
            <div class="toolbar-header">
                <h2>工具</h2>
            </div>
            <div class="tool-buttons">
                <button class="tool-btn active" data-tool="select" title="选择工具 (1)">
                    <i class="fas fa-mouse-pointer"></i>
                    <span>选择</span>
                </button>
                <button class="tool-btn" data-tool="arrow" title="箭头工具 (2)">
                    <i class="fas fa-arrow-right"></i>
                    <span>箭头</span>
                </button>
                <button class="tool-btn" data-tool="note" title="卡片注释 (3)">
                    <i class="fas fa-sticky-note"></i>
                    <span>注释</span>
                </button>
            </div>
            <div class="divider"></div>
            <div class="action-buttons">
                <button class="action-btn" id="saveBtn" title="保存到本地 (Ctrl+S)">
                    <i class="fas fa-save"></i>
                    <span>保存到浏览器缓存</span>
                </button>
                <button class="action-btn action-btn-danger" id="clearCacheBtn" title="清空浏览器缓存">
                    <i class="fas fa-trash-alt"></i>
                    <span>清空浏览器缓存</span>
                </button>
                <button class="action-btn" id="exportBtn" title="导出JSON">
                    <i class="fas fa-file-export"></i>
                    <span>导出文件</span>
                </button>
                <button class="action-btn" id="importBtn" title="导入JSON">
                    <i class="fas fa-file-import"></i>
                    <span>导入文件</span>
                </button>
                <button class="action-btn" id="clearBtn" title="清空画布">
                    <i class="fas fa-trash"></i>
                    <span>清空画布</span>
                </button>
            </div>
            <div class="divider"></div>
            <div class="action-buttons">
                <button class="action-btn" id="helpBtn" title="使用帮助">
                    <i class="fas fa-question-circle"></i>
                    <span>使用帮助</span>
                </button>
            </div>
        </aside>

        <!-- 帮助模态窗口 -->
        <div class="help-modal" id="helpModal">
            <div class="help-modal-overlay" id="helpModalOverlay"></div>
            <div class="help-modal-content">
                <div class="help-modal-header">
                    <h2><i class="fas fa-question-circle"></i> 使用帮助</h2>
                    <button class="help-modal-close" id="helpModalClose">&times;</button>
                </div>
                <div class="help-modal-body">
                    <div class="help-section">
                        <h3><i class="fas fa-keyboard"></i> 快捷键</h3>
                        <div class="help-grid">
                            <div class="help-item">
                                <kbd>1</kbd>
                                <span>选择工具</span>
                            </div>
                            <div class="help-item">
                                <kbd>2</kbd>
                                <span>箭头工具</span>
                            </div>
                            <div class="help-item">
                                <kbd>3</kbd>
                                <span>卡片注释工具</span>
                            </div>
                            <div class="help-item">
                                <kbd>空格</kbd>
                                <span>缩放50%并居中</span>
                            </div>
                            <div class="help-item">
                                <kbd>Delete</kbd>
                                <span>删除选中元素</span>
                            </div>
                            <div class="help-item">
                                <kbd>Esc</kbd>
                                <span>取消选择</span>
                            </div>
                            <div class="help-item">
                                <kbd>滚轮</kbd>
                                <span>移动视图</span>
                            </div>
                            <div class="help-item">
                                <kbd>Ctrl</kbd> + <kbd>滚轮</kbd>
                                <span>缩放视图</span>
                            </div>
                            <div class="help-item">
                                <kbd>Ctrl</kbd> + <kbd>S</kbd>
                                <span>保存到缓存</span>
                            </div>
                            <div class="help-item">
                                <kbd>Ctrl</kbd> + <kbd>E</kbd>
                                <span>导出文件</span>
                            </div>
                            <div class="help-item">
                                <kbd>Ctrl</kbd> + <kbd>I</kbd>
                                <span>导入文件</span>
                            </div>
                            <div class="help-item">
                                <kbd>Ctrl</kbd> + <kbd>0</kbd>
                                <span>重置视图</span>
                            </div>
                        </div>
                    </div>

                    <div class="help-section">
                        <h3><i class="fas fa-mouse-pointer"></i> 操作说明</h3>
                        <ul class="help-list">
                            <li><strong>添加页面</strong>: 从右侧页面库拖拽页面到画布</li>
                            <li><strong>移动元素</strong>: 点击拖拽手柄(顶部标题栏)移动</li>
                            <li><strong>缩放元素</strong>: 选中元素 + Ctrl + 滚轮</li>
                            <li><strong>绘制箭头</strong>: 选择箭头工具,点击起点和终点</li>
                            <li><strong>添加注释</strong>: 选择注释工具,点击画布任意位置</li>
                            <li><strong>编辑注释</strong>: 点击注释内容区域,输入文字</li>
                            <li><strong>调整注释大小</strong>: 拖拽注释卡片的四角手柄</li>
                            <li><strong>框选多个元素</strong>: 选择工具下,在空白处拖拽</li>
                            <li><strong>删除元素</strong>: 选中后按Delete键或点击×按钮</li>
                            <li><strong>右键菜单</strong>: 页面元素右键可打开页面预览</li>
                        </ul>
                    </div>

                    <div class="help-section">
                        <h3><i class="fas fa-exclamation-triangle"></i> 注意事项</h3>
                        <ul class="help-list">
                            <li><strong>浏览器缩放已禁用</strong>: 本页面禁用浏览器的缩放功能</li>
                            <li><strong>画布缩放范围</strong>: 0.1x - 5x</li>
                            <li><strong>自动保存</strong>: 每1分钟自动保存到浏览器缓存</li>
                            <li><strong>页面滚动</strong>: 在页面iframe内可直接滚动查看内容</li>
                            <li><strong>拖拽手柄</strong>: 必须通过顶部标题栏手柄才能拖拽页面元素</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 中央画布区域 -->
        <main class="canvas-area">
            <!-- 页面标签栏 -->
            <div class="page-tabs-bar">
                <div class="page-tabs-container" id="pageTabsContainer">
                    <!-- 标签动态生成 -->
                </div>
                <button class="new-page-btn" id="newPageBtn" title="新建页面 (Ctrl+T)">+</button>
            </div>

            <!-- 顶部状态栏 -->
            <div class="status-bar">
                <span id="elementCount">元素: 0</span>
                <span id="selectedInfo">未选择</span>
                <span id="mousePos">X: 0, Y: 0</span>
                <span id="zoomDisplay">缩放: 50%</span>
            </div>

            <div class="canvas-wrapper" id="canvasWrapper">
                <!-- 垂直滚动条 -->
                <div class="virtual-scrollbar vertical-scrollbar" id="verticalScrollbar">
                    <div class="scrollbar-thumb"></div>
                </div>

                <!-- 水平滚动条 -->
                <div class="virtual-scrollbar horizontal-scrollbar" id="horizontalScrollbar">
                    <div class="scrollbar-thumb"></div>
                </div>

                <div class="canvas" id="canvas">
                    <!-- 画布元素将动态添加到这里 -->
                    <div class="canvas-hint">
                        <i class="fas fa-hand-pointer"></i>
                        <p>从右侧拖拽页面到画布</p>
                        <p>或使用工具添加标注</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- 右侧页面库 -->
        <aside class="sidebar-right">
            <div class="page-library-header">
                <h2>页面库</h2>
                <span id="pageCount">32</span>
            </div>
            <div class="page-library" id="pageLibrary">
                <!-- 页面列表将动态生成 -->
            </div>
        </aside>
    </div>

    <!-- 隐藏的文件输入 -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <!-- JavaScript 文件 -->
    <script src="js/page-library.js"></script>
    <script src="js/virtual-scrollbar.js"></script>
    <script src="js/alignment-manager.js"></script>
    <script src="js/canvas-view.js"></script>
    <script src="js/element-manager.js"></script>
    <script src="js/tools.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/page-manager.js"></script>
    <script src="js/canvas-editor.js"></script>
</body>
</html>