<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title id="pageTitle">画布编辑器</title>

    <!-- 动态加载项目配置并设置标题 -->
    <script>
        (function() {
            fetch('project-config.json')
                .then(response => {
                    if (!response.ok) throw new Error('无法加载项目配置');
                    return response.json();
                })
                .then(config => {
                    document.title = `${config.projectName} - 画布编辑器`;
                })
                .catch(error => {
                    console.warn('使用默认标题:', error);
                    document.title = '画布编辑器';
                });
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/canvas-editor.css">

    <!-- 页面加载时立即设置浏览器缩放防护 -->
    <script>
        // 在DOM加载前就阻止可能的缩放行为
        (function() {
            // 阻止浏览器缩放，但允许canvas-view.js处理画布缩放
            document.addEventListener('wheel', function(e) {
                if (e.ctrlKey) {
                    // 检查是否在iframe内部
                    const isInsideIframe = e.target.closest('.canvas-element.page-element iframe');
                    const isInsideCanvasWrapper = e.target.closest('#canvasWrapper');

                    if (isInsideIframe) {
                        // 在iframe内部：完全阻止浏览器缩放
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        return false;
                    } else if (isInsideCanvasWrapper && !isInsideIframe) {
                        // 在画布区域：只阻止浏览器默认缩放，但不阻止事件传播
                        // 这样canvas-view.js的监听器就能接收到事件并执行画布缩放
                        e.preventDefault();
                        // 注意：这里不调用 stopImmediatePropagation()
                        // 让事件继续传播给canvas-view.js处理
                    }
                    // 其他区域：不阻止，让浏览器默认行为
                }
            }, { passive: false, capture: true });

            // 阻止所有键盘缩放快捷键
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && (e.key === '+' || e.key === '=' || e.key === '-' || e.key === '0')) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, { capture: true });

            // 阻止触摸手势缩放
            document.addEventListener('touchmove', function(e) {
                if (e.scale && e.scale !== 1) {
                    e.preventDefault();
                    return false;
                }
            }, { passive: false, capture: true });

            // 阻止双指缩放手势
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
                return false;
            }, { capture: true });
        })();
    </script>
</head>
<body>
    <!-- 主容器 - 三栏布局 -->
    <div class="app-container">
        <!-- 左侧工具栏 -->
        <aside class="sidebar-left">
            <div class="toolbar-header">
                <h2>页面</h2>
                <button class="add-page-btn" id="addPageBtn" title="新建页面">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            <!-- 页面列表区域 -->
            <div class="page-list-container">
                <div id="pageList" class="page-list">
                    <!-- 页面列表项动态生成 -->
                </div>
            </div>

            <!-- 右键菜单 -->
            <div id="pageContextMenu" class="page-context-menu" style="display: none;">
                <div class="context-menu-item" data-action="rename">
                    <i class="fas fa-edit"></i>
                    <span>重命名</span>
                </div>
                <div class="context-menu-item" data-action="duplicate">
                    <i class="fas fa-copy"></i>
                    <span>复制</span>
                </div>
                <div class="context-menu-item" data-action="delete">
                    <i class="fas fa-trash"></i>
                    <span>删除</span>
                </div>
            </div>
        </aside>

        <!-- 帮助模态窗口 -->
        <div class="help-modal" id="helpModal">
            <div class="help-modal-overlay" id="helpModalOverlay"></div>
            <div class="help-modal-content">
                <div class="help-modal-header">
                    <h2><i class="fas fa-question-circle"></i> 使用帮助</h2>
                    <button class="help-modal-close" id="helpModalClose">&times;</button>
                </div>
                <div class="help-modal-body">
                    <!-- Tab 导航 -->
                    <div class="help-tabs">
                        <button class="help-tab active" data-tab="shortcuts">快捷键</button>
                        <button class="help-tab" data-tab="basic">基础操作</button>
                        <button class="help-tab" data-tab="advanced">高级功能</button>
                        <button class="help-tab" data-tab="faq">常见问题</button>
                    </div>

                    <!-- Tab 内容 -->
                    <div class="help-tab-content">
                        <!-- 快捷键 Tab -->
                        <div class="help-tab-pane active" id="tab-shortcuts">
                            <div class="help-section">
                                <h3><i class="fas fa-tools"></i> 工具切换</h3>
                                <div class="help-grid">
                                    <div class="help-item"><kbd>1</kbd><span>选择工具</span></div>
                                    <div class="help-item"><kbd>2</kbd><span>箭头工具</span></div>
                                    <div class="help-item"><kbd>3</kbd><span>卡片注释工具</span></div>
                                </div>
                            </div>

                            <div class="help-section">
                                <h3><i class="fas fa-arrows-alt"></i> 视图操作</h3>
                                <div class="help-grid">
                                    <div class="help-item"><kbd>空格</kbd><span>缩放50%并居中</span></div>
                                    <div class="help-item"><kbd>滚轮</kbd><span>移动视图</span></div>
                                    <div class="help-item"><kbd>Ctrl</kbd>+<kbd>滚轮</kbd><span>缩放视图</span></div>
                                </div>
                            </div>

                            <div class="help-section">
                                <h3><i class="fas fa-edit"></i> 元素操作</h3>
                                <div class="help-grid">
                                    <div class="help-item"><kbd>Delete</kbd><span>删除选中元素</span></div>
                                    <div class="help-item"><kbd>Esc</kbd><span>取消选择</span></div>
                                </div>
                            </div>

                            <div class="help-section">
                                <h3><i class="fas fa-history"></i> 撤销/重做</h3>
                                <div class="help-grid">
                                    <div class="help-item"><kbd>Ctrl</kbd>+<kbd>Z</kbd><span>撤销</span></div>
                                    <div class="help-item"><kbd>Ctrl</kbd>+<kbd>Y</kbd><span>重做</span></div>
                                    <div class="help-item"><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>Z</kbd><span>重做</span></div>
                                </div>
                            </div>

                            <div class="help-section">
                                <h3><i class="fas fa-file"></i> 文件操作</h3>
                                <div class="help-grid">
                                    <div class="help-item"><kbd>Ctrl</kbd>+<kbd>S</kbd><span>保存到缓存</span></div>
                                </div>
                            </div>

                        </div>

                        <!-- 基础操作 Tab -->
                        <div class="help-tab-pane" id="tab-basic">
                            <div class="help-section">
                                <h3><i class="fas fa-plus-circle"></i> 添加元素</h3>
                                <ul class="help-list">
                                    <li><strong>添加页面</strong>: 从右侧页面库拖拽页面到画布</li>
                                    <li><strong>绘制箭头</strong>: 选择箭头工具,点击起点和终点</li>
                                    <li><strong>添加注释</strong>: 选择注释工具,点击画布任意位置</li>
                                </ul>
                            </div>

                            <div class="help-section">
                                <h3><i class="fas fa-arrows-alt"></i> 移动和调整</h3>
                                <ul class="help-list">
                                    <li><strong>移动页面元素</strong>: 点击拖拽顶部标题栏手柄</li>
                                    <li><strong>调整注释大小</strong>: 拖拽注释卡片的四角手柄</li>
                                </ul>
                            </div>

                            <div class="help-section">
                                <h3><i class="fas fa-mouse-pointer"></i> 选择和删除</h3>
                                <ul class="help-list">
                                    <li><strong>选中元素</strong>: 点击元素即可选中</li>
                                    <li><strong>框选多个</strong>: 选择工具下,在空白处拖拽框选</li>
                                    <li><strong>删除元素</strong>: 选中后按 Delete 键或点击 × 按钮</li>
                                    <li><strong>取消选择</strong>: 按 Esc 键或点击空白区域</li>
                                </ul>
                            </div>

                            <div class="help-section">
                                <h3><i class="fas fa-eye"></i> 视图控制</h3>
                                <ul class="help-list">
                                    <li><strong>移动视图</strong>: 鼠标滚轮滚动</li>
                                    <li><strong>缩放视图</strong>: Ctrl + 滚轮</li>
                                    <li><strong>快速居中</strong>: 按空格键</li>
                                </ul>
                            </div>
                        </div>

                        <!-- 高级功能 Tab -->
                        <div class="help-tab-pane" id="tab-advanced">
                            <div class="help-section">
                                <h3><i class="fas fa-layer-group"></i> 多页面管理</h3>
                                <ul class="help-list">
                                    <li><strong>新建页面</strong>: 点击底部"新建页面"按钮</li>
                                    <li><strong>切换页面</strong>: 点击底部的页面标签切换</li>
                                    <li><strong>排序页面</strong>: 拖拽底部页面标签调整顺序</li>
                                    <li><strong>删除页面</strong>: 点击页面标签上的 ×</li>
                                    <li><strong>独立使用计数</strong>: 每个页面独立统计元素使用次数</li>
                                </ul>
                            </div>

                            <div class="help-section">
                                <h3><i class="fas fa-folder"></i> 页面库功能</h3>
                                <ul class="help-list">
                                    <li><strong>分类折叠</strong>: 点击分类标题可折叠/展开页面列表</li>
                                    <li><strong>分类排序</strong>: 拖拽分类标题调整分类顺序</li>
                                    <li><strong>批量添加</strong>: 点击分类标题右侧的"+"按钮可批量添加该分类所有页面</li>
                                    <li><strong>使用计数徽章</strong>: 显示每个页面在当前页面中的使用次数</li>
                                </ul>
                            </div>

                            <div class="help-section">
                                <h3><i class="fas fa-mouse"></i> 右键菜单</h3>
                                <ul class="help-list">
                                    <li><strong>复制文件路径</strong>: 右键点击页面元素,可复制页面文件路径</li>
                                    <li><strong>保存长截图</strong>: 右键点击页面元素,可将整个页面(包括滚动部分)保存为高清PNG图片</li>
                                </ul>
                            </div>

                            <div class="help-section">
                                <h3><i class="fas fa-history"></i> 撤销/重做</h3>
                                <ul class="help-list">
                                    <li><strong>支持的操作</strong>: 添加/删除/移动元素、页面排序、注释编辑等</li>
                                    <li><strong>历史记录数</strong>: 最多保存50步操作历史</li>
                                    <li><strong>智能恢复</strong>: 撤销时智能复用DOM,避免iframe刷新</li>
                                </ul>
                            </div>

                            <div class="help-section">
                                <h3><i class="fas fa-edit"></i> 注释编辑技巧</h3>
                                <ul class="help-list">
                                    <li><strong>输入内容</strong>: 点击注释内容区域即可输入文字</li>
                                    <li><strong>调整大小</strong>: 拖拽四角手柄可自由调整卡片尺寸</li>
                                    <li><strong>支持数字</strong>: 注释中可以正常输入数字,不会触发工具切换</li>
                                </ul>
                            </div>
                        </div>

                        <!-- 常见问题 Tab -->
                        <div class="help-tab-pane" id="tab-faq">
                            <div class="help-section">
                                <h3><i class="fas fa-question-circle"></i> 常见问题</h3>
                                <ul class="help-list">
                                    <li><strong>Q: 为什么在页面内按 Ctrl+滚轮没有缩放画布?</strong><br>
                                        A: 已禁用 iframe 内的浏览器缩放,现在会正确触发画布缩放</li>

                                    <li><strong>Q: 如何保存包含滚动内容的长截图?</strong><br>
                                        A: 右键点击页面元素,选择"保存长截图",会自动捕获完整页面内容</li>

                                    <li><strong>Q: 页面内容太长,如何截图完整内容?</strong><br>
                                        A: 使用右键菜单的"保存长截图"功能,会自动捕获 scrollHeight 包含的所有内容</li>

                                    <li><strong>Q: 为什么我的页面元素无法拖拽?</strong><br>
                                        A: 必须通过顶部标题栏手柄才能拖拽页面元素,点击其他区域无效</li>

                                    <li><strong>Q: 如何在注释中输入数字?</strong><br>
                                        A: 已修复冲突,现在可以在注释中正常输入数字1/2/3等</li>

                                    <li><strong>Q: 撤销后页面为什么会刷新?</strong><br>
                                        A: 已优化,撤销时智能复用DOM,页面元素不会刷新,只有箭头/注释等会重新渲染</li>
                                </ul>
                            </div>

                            <div class="help-section">
                                <h3><i class="fas fa-info-circle"></i> 重要提示</h3>
                                <ul class="help-list">
                                    <li><strong>画布缩放范围</strong>: 0.1x - 5x</li>
                                    <li><strong>自动保存</strong>: 每1分钟自动保存到浏览器缓存</li>
                                    <li><strong>数据持久化</strong>: 刷新页面不会丢失数据(除非清除浏览器缓存)</li>
                                    <li><strong>浏览器兼容</strong>: 建议使用 Chrome/Edge/Firefox 最新版本</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 确认弹窗 -->
        <div class="confirm-modal" id="confirmModal">
            <div class="help-modal-overlay"></div>
            <div class="confirm-modal-content">
                <div class="confirm-modal-header">
                    <h2 id="confirmModalTitle"><i class="fas fa-exclamation-circle"></i> 确认操作</h2>
                </div>
                <div class="confirm-modal-body">
                    <p id="confirmModalMessage">确定要执行此操作吗?</p>
                </div>
                <div class="confirm-modal-footer">
                    <button class="confirm-modal-btn cancel" id="confirmModalCancel">取消</button>
                    <button class="confirm-modal-btn confirm" id="confirmModalConfirm">确定</button>
                </div>
            </div>
        </div>

        <!-- 输入弹窗 -->
        <div class="prompt-modal" id="promptModal">
            <div class="help-modal-overlay"></div>
            <div class="prompt-modal-content">
                <div class="confirm-modal-header">
                    <h2 id="promptModalTitle"><i class="fas fa-edit"></i> 输入内容</h2>
                </div>
                <div class="prompt-modal-body">
                    <p id="promptModalMessage">请输入内容:</p>
                    <input type="text" id="promptModalInput" class="prompt-modal-input" placeholder="请输入...">
                </div>
                <div class="confirm-modal-footer">
                    <button class="confirm-modal-btn cancel" id="promptModalCancel">取消</button>
                    <button class="confirm-modal-btn confirm" id="promptModalConfirm">确定</button>
                </div>
            </div>
        </div>

        <!-- 中央画布区域 -->
        <main class="canvas-area">
            <!-- 顶部状态栏 -->
            <div class="status-bar">
                <div class="status-bar-left">
                    <span id="elementCount">元素: 0</span>
                </div>

                <div class="status-bar-center">
                    <!-- 工具按钮 -->
                    <button class="tool-icon-btn active" data-tool="select" title="选择工具 (1)">
                        <i class="fas fa-mouse-pointer"></i>
                    </button>
                    <button class="tool-icon-btn" data-tool="arrow" title="箭头工具 (2)">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <button class="tool-icon-btn" data-tool="note" title="注释工具 (3)">
                        <i class="fas fa-sticky-note"></i>
                    </button>

                    <!-- 分隔符 -->
                    <div class="status-bar-divider"></div>

                    <!-- 操作按钮 -->
                    <button class="tool-icon-btn action-btn" id="saveBtn" title="保存到本地 (Ctrl+S)">
                        <i class="fas fa-save"></i>
                    </button>
                    <button class="tool-icon-btn action-btn" id="clearCacheBtn" title="清空浏览器缓存">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <button class="tool-icon-btn action-btn" id="exportBtn" title="导出JSON (Ctrl+E)">
                        <i class="fas fa-file-export"></i>
                    </button>
                    <button class="tool-icon-btn action-btn" id="importBtn" title="导入JSON (Ctrl+I)">
                        <i class="fas fa-file-import"></i>
                    </button>
                    <button class="tool-icon-btn action-btn" id="clearBtn" title="清空画布">
                        <i class="fas fa-eraser"></i>
                    </button>

                    <!-- 分隔符 -->
                    <div class="status-bar-divider"></div>

                    <!-- 帮助按钮 -->
                    <button class="tool-icon-btn action-btn" id="helpBtn" title="使用帮助">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>

                <div class="status-bar-right">
                    <span id="selectedInfo">未选择</span>
                    <span id="mousePos">X: 0, Y: 0</span>
                    <span id="zoomDisplay">缩放: 50%</span>
                </div>
            </div>

            <div class="canvas-wrapper" id="canvasWrapper">
                <!-- 垂直滚动条 -->
                <div class="virtual-scrollbar vertical-scrollbar" id="verticalScrollbar">
                    <div class="scrollbar-thumb"></div>
                </div>

                <!-- 水平滚动条 -->
                <div class="virtual-scrollbar horizontal-scrollbar" id="horizontalScrollbar">
                    <div class="scrollbar-thumb"></div>
                </div>

                <div class="canvas" id="canvas">
                    <!-- 画布元素将动态添加到这里 -->
                    <div class="canvas-hint">
                        <i class="fas fa-hand-pointer"></i>
                        <p>从右侧拖拽页面到画布</p>
                        <p>或使用工具添加标注</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- 右侧页面库 -->
        <aside class="sidebar-right">
            <div class="page-library-header">
                <h2>页面库</h2>
                <span id="pageCount">32</span>
            </div>
            <div class="page-library" id="pageLibrary">
                <!-- 页面列表将动态生成 -->
            </div>
        </aside>
    </div>

    <!-- 隐藏的文件输入 -->
    <input type="file" id="fileInput" accept=".json" style="display: none;">

    <!-- JavaScript 文件 -->
    <!-- html2canvas: 用于DOM截图 -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="js/page-library.js"></script>
    <script src="js/virtual-scrollbar.js"></script>
    <script src="js/alignment-manager.js"></script>
    <script src="js/canvas-view.js"></script>
    <script src="js/element-manager.js"></script>
    <script src="js/tools.js"></script>
    <script src="js/modal-manager.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/page-manager.js"></script>
    <script src="js/history-manager.js"></script>
    <script src="js/canvas-editor.js"></script>
</body>
</html>