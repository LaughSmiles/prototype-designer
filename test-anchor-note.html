<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•é”šç‚¹æ³¨é‡Š</title>
    <link rel="stylesheet" href="css/canvas-editor.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #canvas {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #f5f5f5;
            overflow: hidden;
        }
        .test-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 99999;
        }
        .test-info h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .test-info p {
            margin: 5px 0;
            font-size: 14px;
            color: #666;
        }
        .test-info button {
            margin-top: 10px;
            padding: 8px 16px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="test-info">
        <h3>é”šç‚¹æ³¨é‡Šæµ‹è¯•</h3>
        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»ºä¸€ä¸ªé”šç‚¹æ³¨é‡Š</p>
        <p>ç„¶åæ‹–åŠ¨æ‰¹æ³¨æ¡†æŸ¥çœ‹æ•ˆæœ</p>
        <button onclick="createAnchorNote()">åˆ›å»ºé”šç‚¹æ³¨é‡Š</button>
        <button onclick="checkZIndex()">æ£€æŸ¥z-index</button>
    </div>

    <div id="canvas"></div>

    <script>
        function createAnchorNote() {
            const canvas = document.getElementById('canvas');

            // åˆ›å»ºæµ‹è¯•æ•°æ®
            const testElement = {
                id: 'test-' + Date.now(),
                type: 'note',
                mode: 'anchor',
                anchor: { x: 500, y: 300 },
                text: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é”šç‚¹æ³¨é‡Š',
                position: { x: 560, y: 246 },
                width: 200,
                height: 120
            };

            // åˆ›å»ºæ‰¹æ³¨æ¡†
            const div = document.createElement('div');
            div.classList.add('canvas-element', 'note-element');
            div.dataset.elementId = testElement.id;
            div.dataset.mode = 'anchor';
            div.style.left = testElement.position.x + 'px';
            div.style.top = testElement.position.y + 'px';
            div.style.width = testElement.width + 'px';
            div.style.height = testElement.height + 'px';
            div.style.zIndex = '10000';

            // åˆ›å»ºå†…å®¹åŒº
            const contentDiv = document.createElement('div');
            contentDiv.className = 'note-content';
            contentDiv.contentEditable = 'true';
            contentDiv.textContent = testElement.text;
            div.appendChild(contentDiv);

            canvas.appendChild(div);

            // åˆ›å»ºé”šç‚¹åœ†ç‚¹
            const anchorDot = document.createElement('div');
            anchorDot.className = 'note-anchor-dot';
            anchorDot.dataset.elementId = testElement.id;
            anchorDot.style.left = testElement.anchor.x + 'px';
            anchorDot.style.top = testElement.anchor.y + 'px';
            canvas.appendChild(anchorDot);

            // åˆ›å»ºSVGè¿æ¥çº¿
            const svgLine = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svgLine.setAttribute('class', 'note-connector-line');
            svgLine.dataset.elementId = testElement.id;
            svgLine.style.position = 'absolute';
            svgLine.style.pointerEvents = 'none';
            svgLine.style.overflow = 'visible';
            canvas.appendChild(svgLine);

            // ç»˜åˆ¶è¿æ¥çº¿
            updateConnectorLine(testElement, div, svgLine, anchorDot);

            // æ·»åŠ æ‹–æ‹½åŠŸèƒ½
            addDragFunctionality(div, testElement, svgLine, anchorDot);
            addAnchorDragFunctionality(anchorDot, testElement, svgLine, div);

            console.log('âœ… åˆ›å»ºå®Œæˆ:', testElement);
        }

        function updateConnectorLine(element, div, svgLine, anchorDot) {
            // è®¡ç®—é”šç‚¹ä¸­å¿ƒ (12pxåœ†ç‚¹,åŠå¾„6px)
            const anchorX = element.anchor.x + 6;
            const anchorY = element.anchor.y + 6;

            // è®¡ç®—æ‰¹æ³¨æ¡†è¿æ¥ç‚¹ (å·¦ä¾§è¾¹æ¡†ä¸­å¿ƒ)
            const boxX = element.position.x;
            const boxY = element.position.y + element.height / 2;

            // è®¾ç½®SVGå°ºå¯¸å’Œä½ç½®
            const minX = Math.min(anchorX, boxX);
            const minY = Math.min(anchorY, boxY);
            const maxX = Math.max(anchorX, boxX);
            const maxY = Math.max(anchorY, boxY);

            const padding = 10;
            svgLine.style.left = (minX - padding) + 'px';
            svgLine.style.top = (minY - padding) + 'px';
            svgLine.style.width = (maxX - minX + padding * 2) + 'px';
            svgLine.style.height = (maxY - minY + padding * 2) + 'px';
            svgLine.setAttribute('viewBox', `0 0 ${maxX - minX + padding * 2} ${maxY - minY + padding * 2}`);

            // ç»˜åˆ¶çº¿æ¡
            svgLine.innerHTML = `
                <line
                    x1="${anchorX - minX + padding}"
                    y1="${anchorY - minY + padding}"
                    x2="${boxX - minX + padding}"
                    y2="${boxY - minY + padding}"
                    stroke="#FF9500"
                    stroke-width="2"
                />
            `;
        }

        function addDragFunctionality(div, element, svgLine, anchorDot) {
            let isDragging = false;
            let startX, startY;
            let elementOffsetX, elementOffsetY;

            div.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                elementOffsetX = e.clientX - element.position.x;
                elementOffsetY = e.clientY - element.position.y;

                div.style.cursor = 'grabbing';

                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const newX = e.clientX - elementOffsetX;
                const newY = e.clientY - elementOffsetY;

                element.position.x = newX;
                element.position.y = newY;

                div.style.left = newX + 'px';
                div.style.top = newY + 'px';

                updateConnectorLine(element, div, svgLine, anchorDot);

                console.log('ğŸ“¦ æ‰¹æ³¨æ¡†ä½ç½®:', { x: newX, y: newY });
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    div.style.cursor = 'grab';
                }
            });
        }

        function addAnchorDragFunctionality(anchorDot, element, svgLine, div) {
            let isDragging = false;
            let offsetX, offsetY;

            anchorDot.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                isDragging = true;

                const rect = anchorDot.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;

                e.preventDefault();
                e.stopPropagation();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const canvas = document.getElementById('canvas');
                const canvasRect = canvas.getBoundingClientRect();
                const newX = e.clientX - canvasRect.left - offsetX;
                const newY = e.clientY - canvasRect.top - offsetY;

                element.anchor.x = newX;
                element.anchor.y = newY;

                anchorDot.style.left = newX + 'px';
                anchorDot.style.top = newY + 'px';

                updateConnectorLine(element, div, svgLine, anchorDot);

                console.log('ğŸ”µ é”šç‚¹ä½ç½®:', { x: newX, y: newY });
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        }

        function checkZIndex() {
            const canvas = document.getElementById('canvas');
            const noteBox = canvas.querySelector('.note-element');
            const anchorDot = canvas.querySelector('.note-anchor-dot');
            const svgLine = canvas.querySelector('.note-connector-line');

            console.log('=== z-index æ£€æŸ¥ ===');
            console.log('æ‰¹æ³¨æ¡† z-index:', window.getComputedStyle(noteBox).zIndex);
            console.log('é”šç‚¹åœ†ç‚¹ z-index:', window.getComputedStyle(anchorDot).zIndex);
            console.log('è¿æ¥çº¿ z-index:', window.getComputedStyle(svgLine).zIndex);

            alert(`
æ‰¹æ³¨æ¡†: ${window.getComputedStyle(noteBox).zIndex}
é”šç‚¹åœ†ç‚¹: ${window.getComputedStyle(anchorDot).zIndex}
è¿æ¥çº¿: ${window.getComputedStyle(svgLine).zIndex}
            `);
        }
    </script>
</body>
</html>
